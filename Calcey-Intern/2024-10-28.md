Had a huddle with Nuwan to review the work done in the eye icon task. 
We decided not to implement a separate end point for that instead we can do some modification to an existing end point.
I have done those changes to that end point, but there are few errors came up,
Will work on them today.

****
```C#
using FFF.Domain;
using FFF.Domain.ConfigSettings;
using FFF.Domain.Constants;
using FFF.Domain.Dtos.Base;
using FFF.Domain.Dtos.Business.Accounting;
using FFF.Domain.Dtos.Business.Customer;
using FFF.Domain.Dtos.Business.FoodBox.Delivery;
using FFF.Domain.Dtos.Business.FoodBox.Order;
using FFF.Domain.Dtos.Business.FoodBox.Subscription;
using FFF.Domain.Dtos.LoyaltyRewards;
using FFF.Domain.Dtos.Shared.Emails;
using FFF.Domain.Dtos.Shared.Emails.TemplateData;
using FFF.Domain.Dtos.Shared.Emails.TemplateData.FoodBox;
using FFF.Domain.Dtos.Stripe;
using FFF.Domain.Dtos.System.ActivityLog;
using FFF.Domain.Dtos.System.Address;
using FFF.Domain.Entities.Identity;
using FFF.Domain.Enums;
using FFF.Domain.Exceptions;
using FFF.Domain.Services.Business;
using FFF.Domain.Services.Business.Accounting;
using FFF.Domain.Services.Business.FoodBox;
using FFF.Domain.Services.Business.Marketing;
using FFF.Domain.Services.Business.Payments;
using FFF.Domain.Services.Shared;
using FFF.Domain.Services.Shared.Emails;
using FFF.Domain.Services.System;
using FFF.Utills;
using FFF.Utils.LinqExtensions;
using FFFMaster.Domain.Services.System;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using Microsoft.Extensions.Options;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using X.PagedList;

namespace FFF.Services.Business.FoodBox
{
    public class FoodBoxOrderService : IFoodBoxOrderService
    {
        private readonly IDataContext _dataContext;
        private readonly IPostcodeService _postcodeService;
        private readonly IFoodBoxUtilityService _foodBoxUtilityService;
        private readonly ILoyaltyTokenService _loyaltyTokenService;
        private readonly IFoodBoxDeliveryService _foodBoxDeliveryService;
        private readonly ILogger<FoodBoxOrderService> _logger;
        private readonly IPaymentService _paymentService;
        private readonly IAccountingService _accountingService;
        private readonly IFoodBoxSubscriptionService _foodBoxSubscriptionService;
        private readonly ILookupService _lookupService;
        private readonly IActivityLogService _activityLogService;
        private readonly IDiscountCodeService _discountCodeService;
        private readonly IConfigurationSettingService _configurationSettingService;
        private readonly TenantSettings _tenantSettings;
        private readonly IMarketingPlatformService _marketingPlatformService;
        private readonly IEmailService _emailService;
        private readonly IDateTimeProvider _dateTimeProvider;
        private readonly ISystemErrorLogService _systemErrorLogService;
        private readonly AppSettings _appSettings;
        private readonly AwsSettings _awsSettings;

        public FoodBoxOrderService(IDataContext dataContext,
            IPostcodeService postcodeService,
            IFoodBoxUtilityService foodBoxUtilityService,
            ILoyaltyTokenService loyaltyTokenService,
            IFoodBoxDeliveryService foodBoxDeliveryService,
            ILogger<FoodBoxOrderService> logger,
            IPaymentService paymentService,
            IAccountingService accountingService,
            IFoodBoxSubscriptionService foodBoxSubscriptionService,
            ILookupService lookupService,
            IActivityLogService activityLogService,
            IDiscountCodeService discountCodeService,
            IConfigurationSettingService configurationSettingService,
            IOptions<TenantSettings> tenantSettings,
            IMarketingPlatformService marketingPlatformService,
            IEmailService emailService,
            IDateTimeProvider dateTimeProvider,
            ISystemErrorLogService systemErrorLogService,
            IOptions<AppSettings> appSettings,
            IOptions<AwsSettings> awsSettings)
        {

            _dataContext = dataContext;
            _postcodeService = postcodeService;
            _foodBoxUtilityService = foodBoxUtilityService;
            _loyaltyTokenService = loyaltyTokenService;
            _foodBoxDeliveryService = foodBoxDeliveryService;
            _logger = logger;
            _paymentService = paymentService;
            _loyaltyTokenService = loyaltyTokenService;
            _accountingService = accountingService;
            _foodBoxSubscriptionService = foodBoxSubscriptionService;
            _lookupService = lookupService;
            _activityLogService = activityLogService;
            _discountCodeService = discountCodeService;
            _configurationSettingService = configurationSettingService;
            _tenantSettings = tenantSettings.Value;
            _marketingPlatformService = marketingPlatformService;
            _emailService = emailService;
            _dateTimeProvider = dateTimeProvider;
            _systemErrorLogService = systemErrorLogService;
            _appSettings = appSettings.Value;
            _awsSettings = awsSettings.Value;
        }

        public async Task<SearchResultsDto<FoodBoxOrderListItemDto>> GetAllFilteredAsync(FoodBoxOrderListSearchFilterDto filter)
        {
            var searchTerm = filter.SearchTerm?.Trim().ToLower();

            var orders = await _dataContext.FoodBoxOrders.
                Where(o => (string.IsNullOrWhiteSpace(filter.UserId) || o.UserId == filter.UserId) &&
                    (string.IsNullOrEmpty(searchTerm) ||
                    o.OrderNo.ToString().Contains(searchTerm) ||
                    o.User.Email.Contains(searchTerm) ||
                    o.User.FirstName.ToLower().Contains(searchTerm) ||
                    o.User.LastName.ToLower().Contains(searchTerm)) &&
                    (!filter.OrderStatus.HasValue || o.Status == filter.OrderStatus))
                .Select(o => new FoodBoxOrderListItemDto
                {
                    Id = o.Id,
                    UserId = o.UserId,
                    OrderNo = o.OrderNo,
                    CustomerName = o.User.FirstName + " " + o.User.LastName,
                    OrderStatus = o.Status,
                    CreatedDate = o.CreatedDateUtc,
                    FirstDeliveryDate = o.DeliveryDays.Min(x => x.Date),
                    TotalAmount = o.Total,
                })
                .ToSortedPagedListAsync(filter);

            return orders;
        }

        public async Task<FoodBoxOrderDetailsDto> GetDetailsByIdAsync(string id)
        {
            var order = await _dataContext.FoodBoxOrders
                .Where(o => o.Id == id)
                .Select(o => new FoodBoxOrderDetailsDto
                {
                    Id = o.Id,
                    UserId = o.UserId,
                    OrderNo = o.OrderNo,
                    Status = o.Status,
                    SubTotal = o.SubTotal,
                    DeliveryCharge = o.DeliveryCharge,
                    Discount = o.Discount,
                    Total = o.Total,
                    DeliveryAddress = new AddressDto
                    {
                        Line1 = o.DefaultDeliveryInfo.Address.Line1,
                        Line2 = o.DefaultDeliveryInfo.Address.Line2,
                        City = o.DefaultDeliveryInfo.Address.City,
                        County = o.DefaultDeliveryInfo.Address.County,
                        PostCode = o.DefaultDeliveryInfo.Address.PostCode,
                        Country = o.DefaultDeliveryInfo.Address.Country,
                    },
                    PostcodeGroupId = o.DefaultDeliveryInfo.PostcodeGroupId,
                    DeliveryDays = o.DeliveryDays.Select(d => new FoodBoxDeliveryDayDetailsDto
                    {
                        Date = d.Date,
                        SubTotal = d.SubTotal,
                        DeliveryCharge = d.DeliveryCharge,
                        Discount = d.Discount,
                        //Items = null,
                        //o.Status == (OrderStatus.Completed) ? GetCompletedOrdersItemDetail(_dataContext, o.Id, d.Id) : GetOngoingOrdersItemDetails(_dataContext, o.Id, d.Id)
                    })
                    .OrderBy(d => d.Date)
                    .ToList(),
                })
                .FirstOrDefaultAsync();

            if (order is null)
            {
                throw new RecordNotFoundException("FoodBoxOrder", id);
            }

            var hasOtherFoodBoxOrders = await _dataContext.FoodBoxOrders
                .Where(o => o.UserId == order.UserId && o.Id != order.Id)
                .AnyAsync();

            order.IsSkippable = hasOtherFoodBoxOrders;

            foreach (var deliveryDay in order.DeliveryDays)
            {
                deliveryDay.SectionTypeItemCountMap = deliveryDay.Items
                    .GroupBy(i => i.MenuItemSectionTypeId)
                    .ToDictionary(g => g.Key, g => g.Sum(v => v.Quantity));
            }

            if(order is not null)
            {
                var transaction = _dataContext.Transactions
                    .Where(t => t.OrderId == order.Id)
                    .Select(t => new {
                        ledger = t.TransactionLines
                             .GroupBy(l => l.LedgerCode.Code)
                             .ToDictionary(g => g.Key, g => g.Sum(l => l.Amount)),
                        category = t.TransactionCategory

                    }).FirstOrDefault();
                var TransactionBreakdown = TransactionService.GetTransactionBreakdown(transaction.ledger, transaction.category);

            }

            var firstDeliveryDate = order.DeliveryDays.Min(x => x.Date);
            order.OrderUpdateCutoffDateTime = await _foodBoxUtilityService.GetPreviousOrderUpsertCutoffDateTimeByDateAsync(firstDeliveryDate);
            
            return order;
        }

        private List<FoodBoxDeliveryItemDetailsDto> GetOngoingOrdersItemDetails(IDataContext context,string orderId, string dayId)
        {
            var Items = context.FoodBoxDeliveryDayItems
                .Where(ddi => ddi.DeliveryDay.OrderId == orderId && ddi.DeliveryDayId == dayId)
                .Select(i => new FoodBoxDeliveryItemDetailsDto
                {
                    MenuItemId = i.FoodBoxMenuItemId,
                    ItemId = i.FoodBoxMealVariationId ?? i.FoodBoxExtraId,
                    Type = i.Type,
                    Quantity = i.Quantity,
                    DietaryPreferenceIds = i.FoodBoxMealVariation.DietaryPreferenceMappings
                                .Select(mapping => mapping.DietaryPreferenceId)
                                .ToList(),
                    PortionSizeId = i.FoodBoxMealVariation.PortionSizeId,
                    ThumbnailUrl = i.FoodBoxMealVariation.ThumbnailUrl ?? i.FoodBoxExtra.ThumbnailUrl,
                    MenuItemName = i.FoodBoxMenuItem.Name,
                    MenuItemSectionTypeId = i.FoodBoxMenuItem.SectionTypeId,
                    MenuItemThumbnailUrl = i.FoodBoxMenuItem.ThumbnailUrl
                })
                .OrderBy(i => i.MenuItemName)
                .ToList();

            return Items;
        }

        private List<FoodBoxDeliveryItemDetailsDto> GetCompletedOrdersItemDetail(IDataContext context, string orderId, string dayId)
        {
            var Items = context.FoodBoxDeliveryDayItemLogs
                .Where(log => log.FoodBoxDeliveryDayItem.DeliveryDay.OrderId == orderId && log.FoodBoxDeliveryDayItem.DeliveryDayId == dayId)
                .Select(log => new FoodBoxDeliveryItemDetailsDto
                {
                    MenuItemId = log.FoodBoxDeliveryDayItem.FoodBoxMenuItemId,
                    ItemId = log.FoodBoxDeliveryDayItem.FoodBoxMealVariationId ?? log.FoodBoxDeliveryDayItem.FoodBoxExtraId,
                    Type = log.FoodBoxDeliveryDayItem.Type,
                    Quantity = log.Quantity,
                    UnitPrice = log.FoodBoxDeliveryDayItem.UnitPrice,
                    DietaryPreferenceIds = log.FoodBoxDeliveryDayItem.FoodBoxMealVariation.DietaryPreferenceMappings
                                .Select(mapping => mapping.DietaryPreferenceId)
                                .ToList(),
                    PortionSizeId = log.PortionSizeId,
                    ThumbnailUrl = log.FoodBoxDeliveryDayItem.FoodBoxMealVariation.ThumbnailUrl ?? log.FoodBoxDeliveryDayItem.FoodBoxExtra.ThumbnailUrl,
                    MenuItemName = log.FoodBoxMenuItemName,
                    MenuItemSectionTypeId = log.FoodBoxDeliveryDayItem.FoodBoxMenuItem.SectionTypeId,
                    MenuItemThumbnailUrl = log.FoodBoxDeliveryDayItem.FoodBoxMenuItem.ThumbnailUrl
                })
                .OrderBy(items => items.MenuItemName)
                .ToList();

            return Items;
        }

        public async Task<FoodBoxOrderSummaryDto> GetSummaryByIdAsync(string id)
        {
            var order = await _dataContext.FoodBoxOrders
                .Where(o => o.Id == id)
                .Select(o => new FoodBoxOrderSummaryDto
                {
                    Id = o.Id,
                    OrderNo = o.OrderNo,
                    CustomerNo = o.User.Customer.CustomerNo.ToString(),
                    Email = o.User.Email,
                    FirstDeliveryDate = o.DeliveryDays.Min(x => x.Date),
                })
                .FirstOrDefaultAsync();

            if (order is null)
            {
                throw new RecordNotFoundException("FoodBoxOrder", id);
            }

            order.OrderUpdateCutoffDateTime = await _foodBoxUtilityService.GetPreviousOrderUpsertCutoffDateTimeByDateAsync(order.FirstDeliveryDate);
            order.PaymentDate = _foodBoxUtilityService.GetPreviousPaymentDateByDateAsync(order.FirstDeliveryDate);

            return order;
        }

        public async Task<FoodBoxOrderUpdateDetailsDto> GetUpdateDetailsByIdAsync(string id)
        {
            var order = await _dataContext.FoodBoxOrders
                .Where(o => o.Id == id)
                .Select(o => new FoodBoxOrderUpdateDetailsDto
                {
                    UserId = o.UserId,
                    PostcodeGroupId = o.DefaultDeliveryInfo.PostcodeGroupId,
                    IsTimedDelivery = o.DefaultDeliveryInfo.IsTimelyDelivery,
                    Items = o.DeliveryDays
                        .SelectMany(d => d.Items)
                        .Select(i => new FoodBoxCartItemDto
                        {
                            Date = i.DeliveryDay.Date,
                            MenuItemId = i.FoodBoxMenuItemId,
                            MenuItemName = i.FoodBoxMenuItem.Name,
                            ItemId = i.Type == FoodBoxMenuItemType.Meal ? i.FoodBoxMealVariationId : i.FoodBoxExtraId,
                            ItemType = i.Type,
                            Quantity = i.Quantity,
                            UnitPrice = i.Type == FoodBoxMenuItemType.Meal ? i.FoodBoxMealVariation.UnitPrice : i.FoodBoxExtra.UnitPrice,
                            DietaryPreferenceIds = i.FoodBoxMealVariation.DietaryPreferenceMappings
                                .Select(m => m.DietaryPreferenceId)
                                .ToList(),
                            PortionSizeId = i.FoodBoxMealVariation.PortionSizeId,
                            SectionTypeId = i.FoodBoxMenuItem.SectionTypeId
                        })
                        .OrderBy(i => i.MenuItemName)
                        .ToList(),
                    DiscountCode = o.DiscountCode != null ? o.DiscountCode.Code : null,
                })
                .FirstOrDefaultAsync();

            if (order is null)
            {
                throw new RecordNotFoundException("FoodBoxOrder", id);
            }

            order.DeliveryWeekInfo = await _foodBoxDeliveryService.GetDeliveryWeekInfoOfOrderAsync(id);

            return order;
        }

        public async Task<FoodBoxCartValidationResultDto> ValidateCartAsync(FoodBoxCartValidationRequestDto validationRequestDto)
        {
            if (validationRequestDto.Items == null || !validationRequestDto.Items.Any() || string.IsNullOrWhiteSpace(validationRequestDto.PostcodeGroupId))
            {
                throw new ValidationException("ERR_MISSING_REQUIRED_FIELDS");
            }

            var postcodeSchema = await _postcodeService.GetPostcodeGroupSchemaDtoByPostcodeGroupAndDateAsync(validationRequestDto.PostcodeGroupId);

            var (foodBoxMealVariationPriceMap, foodBoxExtraPriceMap) = await ValidateAndGetFoodBoxItemsAsync(validationRequestDto.Items);

            var groupedCartItemsByDate = validationRequestDto.Items.GroupBy(x => x.Date);

            decimal subTotal = 0m;
            List<FoodBoxOrderPricingErrorDto> errorList = new();

            foreach (var group in groupedCartItemsByDate)
            {
                decimal dailyOrderValue = 0;

                foreach (var item in group)
                {
                    decimal unitPrice = item.ItemType switch
                    {
                        FoodBoxMenuItemType.Meal => foodBoxMealVariationPriceMap.GetValueOrDefault(item.ItemId),
                        FoodBoxMenuItemType.Extra => foodBoxExtraPriceMap.GetValueOrDefault(item.ItemId),
                        _ => 0
                    };

                    dailyOrderValue += item.Quantity * unitPrice;
                }

                if (dailyOrderValue < postcodeSchema.FoodBoxMinPerDayOrderValue)
                {
                    errorList.Add(new FoodBoxOrderPricingErrorDto
                    {
                        ErrorCode = FoodBoxOrderPricingErrorCodes.MinPerDayOrderValueNotMet,
                        DateBelowMinOrderValue = group.Key,
                        Deficit = postcodeSchema.FoodBoxMinPerDayOrderValue - dailyOrderValue
                    });
                }

                subTotal += dailyOrderValue;
            }

            // Validate min order value for discount.
            var minOrderValueForDiscount = await _configurationSettingService.GetValueAsDecimalAsync(ConfigurationCodes.FoodBoxMinOrderValueForDiscount);
            if (!string.IsNullOrEmpty(validationRequestDto.DiscountCode) && subTotal < minOrderValueForDiscount)
            {
                errorList.Add(new FoodBoxOrderPricingErrorDto
                {
                    ErrorCode = FoodBoxOrderPricingErrorCodes.MinOrderValueForDiscountNotMet,
                    Deficit = minOrderValueForDiscount - subTotal
                });
            }

            if (subTotal >= postcodeSchema.FoodBoxMinFirstOrderValue ||
                (!string.IsNullOrEmpty(validationRequestDto.UserId) && await GetUserConfirmedFoodBoxOrderCountAsync(validationRequestDto.UserId) > 0))
            {
                return new FoodBoxCartValidationResultDto
                {
                    HasErrors = errorList.Any(),
                    Errors = errorList
                };
            }

            // Calculate the delivery charge
            var deliveryCharge = await CalculateDeliveryChargeAsync(validationRequestDto.PostcodeGroupId, validationRequestDto.IsTimedDelivery, groupedCartItemsByDate.Count());
            var totalWithDeliveryCharge = subTotal + deliveryCharge;

            if (totalWithDeliveryCharge < postcodeSchema.FoodBoxMinFirstOrderValue)
            {
                errorList.Add(new FoodBoxOrderPricingErrorDto
                {
                    ErrorCode = FoodBoxOrderPricingErrorCodes.MinFirstOrderValueNotMet,
                    Deficit = postcodeSchema.FoodBoxMinFirstOrderValue - totalWithDeliveryCharge
                });
            }

            return new FoodBoxCartValidationResultDto
            {
                HasErrors = errorList.Any(),
                Errors = errorList
            };
        }

        public async Task<FoodBoxOrderPricingSummaryDto> GetOrderPricingSummaryAsync(FoodBoxOrderPricingSummaryRequestDto requestDto)
        {
            if (requestDto.Items == null || !requestDto.Items.Any() || string.IsNullOrWhiteSpace(requestDto.PostcodeGroupId))
            {
                throw new ValidationException("ERR_MISSING_REQUIRED_FIELDS");
            }

            var (foodBoxMealVariationPriceMap, foodBoxExtraPriceMap) = await ValidateAndGetFoodBoxItemsAsync(requestDto.Items);

            var dailyPricingSummaryList = new List<FoodBoxDailyPricingSummaryDto>();
            var deliveryCharge = await CalculateDeliveryChargeAsync(requestDto.PostcodeGroupId, requestDto.IsTimedDelivery, 1);

            var groupedCartItemsByDate = requestDto.Items.GroupBy(x => x.Date);

            foreach (var group in groupedCartItemsByDate)
            {
                var dailySubTotal = 0m;

                foreach (var item in group)
                {
                    decimal unitPrice = item.ItemType switch
                    {
                        FoodBoxMenuItemType.Meal => foodBoxMealVariationPriceMap.GetValueOrDefault(item.ItemId),
                        FoodBoxMenuItemType.Extra => foodBoxExtraPriceMap.GetValueOrDefault(item.ItemId),
                        _ => 0
                    };

                    item.UnitPrice = unitPrice;
                    dailySubTotal += item.Quantity * unitPrice;
                }

                dailyPricingSummaryList.Add(new FoodBoxDailyPricingSummaryDto
                {
                    Date = group.Key,
                    SubTotal = dailySubTotal,
                    DeliveryCharge = deliveryCharge,
                    Items = group.ToList()
                });
            }

            // Calculate sub total
            var subTotal = dailyPricingSummaryList.Sum(x => x.SubTotal);

            // Calculate discount amount
            decimal discountAmount = 0m;
            if (!string.IsNullOrWhiteSpace(requestDto.DiscountCode))
            {
                var totalToBeDiscounted = subTotal;

                var minOrderValueForDiscount = await _configurationSettingService.GetValueAsDecimalAsync(ConfigurationCodes.FoodBoxMinOrderValueForDiscount);

                if (totalToBeDiscounted >= minOrderValueForDiscount)
                {
                    var discount = await _dataContext.DiscountCodes
                        .Where(d => d.Code == requestDto.DiscountCode)
                        .Select(d => new
                        {
                            d.WaiverType,
                            d.FoodBoxDiscountValue,
                            d.FoodBoxMaxDiscountValue,
                        })
                        .FirstOrDefaultAsync();

                    if (discount is not null)
                    {
                        var calculatedDiscountAmount = discount.WaiverType switch
                        {
                            WaiverType.Amount => Math.Min(totalToBeDiscounted, Convert.ToDecimal(discount.FoodBoxDiscountValue)),
                            WaiverType.Percentage => subTotal * Convert.ToDecimal(discount.FoodBoxDiscountValue) / 100,
                            _ => 0
                        };

                        discountAmount = discount.FoodBoxMaxDiscountValue > 0 ? Math.Min(calculatedDiscountAmount, Convert.ToDecimal(discount.FoodBoxMaxDiscountValue)) : calculatedDiscountAmount;

                        // Apply discount to daily pricing summary
                        dailyPricingSummaryList.ForEach(x => x.Discount = discountAmount / subTotal * x.SubTotal);
                    }
                }
            }

            // Calculate total delivery charge
            var totalDeliveryCharge = dailyPricingSummaryList.Sum(x => x.DeliveryCharge);

            // Calculate amount to be paid in cash, credit and tokens
            var total = subTotal + totalDeliveryCharge - discountAmount;

            // Calculate token amount
            int tokenAmount = 0;
            decimal tokenMonetaryValue = 0m;
            if (!string.IsNullOrWhiteSpace(requestDto.UserId))
            {
                (tokenAmount, tokenMonetaryValue) = await _loyaltyTokenService.GetMaximumApplicableTokensWithMonetaryValueAsync(requestDto.UserId, total);
            }

            var userPayable = total - tokenMonetaryValue;

            var pricingSummary = new FoodBoxOrderPricingSummaryDto
            {
                TotalDeliveryCharge = totalDeliveryCharge,
                TotalDiscountAmount = discountAmount,
                ApplicableTokenAmount = tokenAmount,
                ApplicableTokenPayment = tokenMonetaryValue,
                SubTotal = subTotal,
                Total = total,
                UserPayable = userPayable,
                DailyPricingSummaryList = dailyPricingSummaryList
            };

            return pricingSummary;
        }

        public async Task ProcessOrderPaymentsAsync(DateTime effectiveDate, bool paymentSecondAttempt)
        {
            var firstDateOfNextWeek = DateTimeHelper.GetNextWeekday(effectiveDate, DayOfWeek.Monday);
            var allBusinessDatesOfNextWeek = DateTimeHelper.GetAllBusinessDatesOfTheWeekOfDate(firstDateOfNextWeek, _tenantSettings.BusinessDays);

            var pendingDraftedOrders = await _dataContext.FoodBoxOrders
                .Where(o => o.Status == OrderStatus.Drafted &&
                    o.DeliveryDays.All(d => d.Date.Date >= allBusinessDatesOfNextWeek.Min() &&
                        d.Date.Date <= allBusinessDatesOfNextWeek.Max()))
                .Select(o => new
                {
                    OrderId = o.Id,
                    o.UserId,
                    o.OrderNo,
                    Customer = new CustomerDto
                    {
                        Email = o.User.Email,
                        FirstName = o.User.FirstName,
                        LastName = o.User.LastName,
                        CustomerNumber = o.User.Customer.CustomerNo
                    }
                })
                .ToListAsync();

            _logger.LogInformation($"FoodBox order payment cycle order count: {pendingDraftedOrders.Count}");

            var failedWeeklyPayments = new List<FailedWeeklyPaymentDetailDto>();

            foreach (var info in pendingDraftedOrders)
            {
                await ProcessPaymentForASingleOrderAsync(info.UserId, info.OrderId, info.OrderNo, info.Customer, failedWeeklyPayments, paymentSecondAttempt);
            }

            await SendWeeklyPaymentsFailedEmailToAdminAsync(failedWeeklyPayments, effectiveDate, paymentSecondAttempt);
        }

        public async Task<bool> HasExistingOrdersForUserAsync(string userId)
        {
            var hasExistingOrders = await _dataContext.FoodBoxOrders.AnyAsync(o => o.UserId == userId);
            return hasExistingOrders;
        }

        private async Task ProcessPaymentForASingleOrderAsync(string userId, string orderId, int orderNo, CustomerDto customerInfo, List<FailedWeeklyPaymentDetailDto> failedWeeklyPayments, bool paymentSecondAttempt)
        {
            decimal finalDirectPayment = 0;
            try
            {
                var makePaymentResult = await TransactionHelper.ExecuteInTransaction(_dataContext, async () =>
                {
                    var orderAndDeliveryInfo = await _dataContext.FoodBoxOrders
                        .Include(o => o.DiscountCode)
                        .Where(o => o.Id == orderId)
                        .Select(o => new
                        {
                            Order = o,
                            HasActiveOrders = o.User.FoodBoxOrders.Any(o => o.Status == OrderStatus.Started || o.Status == OrderStatus.Resumed),
                            o.DeliveryDays,
                        })
                        .FirstOrDefaultAsync() ?? throw new RecordNotFoundException("FoodBoxOrder", orderId);

                    var order = orderAndDeliveryInfo.Order;

                    if (order.Status != OrderStatus.Drafted)
                    {
                        throw new FFFException("ERR_INVALID_ORDER_STATUS");
                    }

                    finalDirectPayment = order.Total;

                    // Calculate token amount
                    var (tokenAmount, tokenMonetaryValue) = await _loyaltyTokenService.GetMaximumApplicableTokensWithMonetaryValueAsync(order.UserId, finalDirectPayment);

                    finalDirectPayment -= tokenMonetaryValue;

                    // Calculate credit amount
                    var remainingCredit = await _accountingService.GetCreditBalanceAsync(order.UserId);
                    var creditToBeConsumed = Math.Min(remainingCredit, finalDirectPayment);

                    finalDirectPayment -= creditToBeConsumed;

                    order.Status = orderAndDeliveryInfo.HasActiveOrders ? OrderStatus.Pending : OrderStatus.Started;

                    foreach (var deliveryDay in order.DeliveryDays)
                    {
                        deliveryDay.Status = orderAndDeliveryInfo.HasActiveOrders ? DeliveryStatus.Pending : DeliveryStatus.Active;
                    }

                    await _dataContext.SaveChangesAsync();

                    var makePaymentDto = new MakePaymentDto
                    {
                        FoodBoxOrderId = orderId,
                        TransactionCategory = TransactionCategory.OrderPlacement,
                        PaymentType = PaymentType.Recurring,
                        Discount = order.Discount,
                        TokensToBeConsumed = tokenAmount,
                        UtilizedTokenAmount = tokenMonetaryValue,
                        CreditToBeConsumed = creditToBeConsumed,
                        Payment = finalDirectPayment,
                        Description = TransactionDescriptionHelper.GetFoodBoxOrderPlacementDescription(order.OrderNo),
                        PaymentChannel = PaymentChannel.FoodBox,
                        ThreeDSEnabled = false,
                        CustomerRefNo = customerInfo.CustomerNumber.ToString()
                    };

                    var makePaymentResult = await _paymentService.MakePaymentAsync(order.UserId, makePaymentDto);

                    try
                    {
                        if (order.DiscountCode != null)
                        {
                            await _discountCodeService.UpdateUsageAndGrantTokensByDiscountCodeAsync(order.DiscountCode.Code, order.Total, new LoyaltyTokenUpsertRequestDto
                            {
                                FoodBoxOrderId = orderId
                            });
                        }

                        await _marketingPlatformService.UpsertPlatformClientOrderDetailsAsync(order.UserId);

                        await SendOrderPlacedEmailAsync(orderId);
                    }
                    catch (Exception ex)
                    {
                        _logger.LogCritical(ex, $"FoodBox order payment collection exception - Post Payment {order.OrderNo}");
                    }

                    return makePaymentResult;
                });
            }
            catch (Exception ex)
            {
                try
                {
                    _logger.LogCritical(ex, $"Error while procssing payment for FoodBox order {orderNo}: {ex.Message}");

                    await _activityLogService.LogActivityAsync(new ActivityLogRequestDto
                    {
                        Action = paymentSecondAttempt ? ActivityLogAction.FoodBoxOrderPaymentSecondAttemptFailed : ActivityLogAction.FoodBoxOrderPaymentFirstAttemptFailed,
                        UserId = userId,
                        ActionedByUserId = userId,
                        FoodBoxOrderId = orderId,
                        Data = new
                        {
                            orderNo,
                        }
                    });

                    failedWeeklyPayments.Add(new FailedWeeklyPaymentDetailDto
                    {
                        RaiseToClient = true,
                        FirstName = customerInfo.FirstName,
                        LastName = customerInfo.LastName,
                        Email = customerInfo.Email,
                        ClientId = customerInfo.CustomerNumber,
                        PaymentAmount = finalDirectPayment,
                        Reason = ex.Message,
                    });

                    await SendFailedWeeklyPaymentEmailToUserAsync(finalDirectPayment, customerInfo, paymentSecondAttempt);

                    if (paymentSecondAttempt)
                    {
                        var cancellationReasonId = await _lookupService.GetIdAsync(LookupHeaderCodes.OrderCancellationReasons, LookupCodes.OrderCancellationReasons.System);

                        var cancellationRequest = new FoodBoxSubscriptionCancellationRequestDto
                        {
                            CancellationReasonId = cancellationReasonId,
                        };
                        await _foodBoxSubscriptionService.CancelSubscriptionByUserIdAsync(userId, cancellationRequest);
                    }
                }
                catch (Exception inEx)
                {
                    var message = $"Error while handling weekly payment exception for Select Order {orderNo}: {inEx.Message}";

                    _logger.LogCritical(inEx, message);

                    await _systemErrorLogService.LogErrorAsync("Select Weekly Payment Exception - While Handling",
                               message, DateTime.UtcNow, new string[] { inEx.ToString() });
                }
            }
        }

        #region Support Methods
        private async Task<decimal> CalculateDeliveryChargeAsync(string postcodeGroupId, bool isTimedDelivery, int dayCount)
        {
            var deliveryCharge = 0m;

            if (isTimedDelivery)
            {
                var timedDeliveryCharge = await _configurationSettingService.GetValueAsDecimalAsync(ConfigurationCodes.TimelyCharge);
                deliveryCharge += timedDeliveryCharge;
            }

            return deliveryCharge * dayCount;
        }

        private async Task<int> GetUserConfirmedFoodBoxOrderCountAsync(string userId)
        {
            var userConfirmedFoodBoxOrderCount = await _dataContext.FoodBoxOrders
                .Where(o => o.UserId == userId &&
                    (o.Status == OrderStatus.Started || o.Status == OrderStatus.Resumed || o.Status == OrderStatus.Completed || o.Status == OrderStatus.Pending))
                .CountAsync();

            return userConfirmedFoodBoxOrderCount;
        }

        private async Task<(Dictionary<string, decimal> foodBoxMealVariationPriceMap, Dictionary<string, decimal> foodBoxExtraPriceMap)> ValidateAndGetFoodBoxItemsAsync(List<FoodBoxCartItemDto> items)
        {
            var mealItems = items
                .Where(item => item.ItemType == FoodBoxMenuItemType.Meal)
                .Select(item => item.ItemId)
                .Distinct()
                .ToList();

            var extraItems = items
                .Where(item => item.ItemType == FoodBoxMenuItemType.Extra)
                .Select(item => item.ItemId)
                .Distinct()
                .ToList();

            var foodBoxMealVariationPriceMap = await _dataContext.FoodBoxMealVariations
                .Where(x => !x.Inactive && mealItems.Contains(x.Id))
                .ToDictionaryAsync(x => x.Id, x => x.UnitPrice);

            var foodBoxExtraPriceMap = await _dataContext.FoodBoxExtras
                .Where(x => !x.Inactive && extraItems.Contains(x.Id))
                .ToDictionaryAsync(x => x.Id, x => x.UnitPrice);

            if (foodBoxMealVariationPriceMap.Count != mealItems.Count || foodBoxExtraPriceMap.Count != extraItems.Count)
            {
                throw new ValidationException("ERR_FOODBOX_INVALID_ITEM");
            }

            return (foodBoxMealVariationPriceMap, foodBoxExtraPriceMap);
        }

        private async Task SendOrderPlacedEmailAsync(string orderId)
        {
            var draftData = await _dataContext.FoodBoxOrders.Where(o => o.Id == orderId)
                .Select(o => new
                {
                    EmailData = new FoodBoxOrderPlacedEmailDataDto
                    {
                        Email = o.User.Email,
                        FirstName = o.User.FirstName,
                        LastName = o.User.LastName,
                        OrderNumber = o.OrderNo.ToString(),
                        OrderType = MainOrderTypes.FoodBox,
                        ChargeDate = _dateTimeProvider.Now.ToString("dd/MM/yyyy"),
                        NumberOfItems = o.DeliveryDays.Sum(d => d.Items.Sum(i => i.Quantity)),
                        DiscountCode = o.DiscountCode != null ? o.DiscountCode.Code : null,
                        DiscountValue = Math.Round(o.Discount, 2).ToString(),
                        TotalPaidPrice = Math.Round(o.Total, 2).ToString(),
                    },
                    ItemList = o.DeliveryDays.SelectMany(d => d.Items)
                        .OrderBy(i => i.FoodBoxMenuItem.Type)
                            .ThenBy(i => i.FoodBoxMenuItem.Name)
                        .Select(i => new
                        {
                            Item = new FoodBoxOrderItem
                            {
                                Name = i.FoodBoxMenuItem.Name,
                                PortionSize = i.FoodBoxMealVariation != null ? i.FoodBoxMealVariation.PortionSize.Description : null,
                                NutritionPreference = i.FoodBoxMealVariation != null ? string.Join(", ",
                                i.FoodBoxMealVariation.DietaryPreferenceMappings
                                    .OrderBy(m => m.DietaryPreference.SortOrder)
                                    .Select(m => m.DietaryPreference.Description)
                                ) : null,
                                ImageUrl = i.FoodBoxMealVariation != null ? i.FoodBoxMealVariation.ThumbnailUrl :
                                    i.FoodBoxExtra != null ? i.FoodBoxExtra.ThumbnailUrl :
                                    i.FoodBoxMenuItem.ThumbnailUrl,
                            },
                            i.DeliveryDay.Date.DayOfWeek
                        }).ToList(),
                })
                .FirstOrDefaultAsync();

            draftData.ItemList.Select(d => d.Item).ToList()
                .ForEach(i => i.ImageUrl = !string.IsNullOrWhiteSpace(i.ImageUrl) ? $"{_awsSettings.AccessUrlDomain}/{_awsSettings.BucketName}/" + i.ImageUrl : null);

            var emailData = draftData.EmailData;

            emailData.ItemsOrderedMon = draftData.ItemList.Where(i => i.DayOfWeek == DayOfWeek.Monday).Select(i => i.Item).ToList();
            emailData.ItemsOrderedTue = draftData.ItemList.Where(i => i.DayOfWeek == DayOfWeek.Tuesday).Select(i => i.Item).ToList();
            emailData.ItemsOrderedWed = draftData.ItemList.Where(i => i.DayOfWeek == DayOfWeek.Wednesday).Select(i => i.Item).ToList();
            emailData.ItemsOrderedThu = draftData.ItemList.Where(i => i.DayOfWeek == DayOfWeek.Thursday).Select(i => i.Item).ToList();
            emailData.ItemsOrderedFri = draftData.ItemList.Where(i => i.DayOfWeek == DayOfWeek.Friday).Select(i => i.Item).ToList();

            var toUser = new EmailUserDto
            {
                Email = emailData.Email,
                Name = $"{emailData.FirstName} {emailData.LastName}"
            };

            await _emailService.SendEmailAsync(EmailTemplateType.FoodBoxOrderPlaced, toUser, emailData);
        }

        private async Task SendFailedWeeklyPaymentEmailToUserAsync(decimal paymentAmount, CustomerDto customer, bool isSecondAttempt)
        {
            var templateType = isSecondAttempt ? EmailTemplateType.FailedWeeklyPaymentFri : EmailTemplateType.FailedWeeklyPaymentWed;

            var toUser = new EmailUserDto
            {
                Email = customer.Email,
                Name = $"{customer.FirstName} {customer.LastName}"
            };

            var emailData = new WeeklyPaymentFailedPromptEmailData
            {
                FirstName = customer.FirstName,
                LastName = customer.LastName,
                Email = customer.Email,
                PaymentAmount = paymentAmount.ToString("C"),
                OrderType = MainOrderTypes.FoodBox,
                LoginUrl = $"{_appSettings.PortalUrl}{SharedConstants.Urls.UserProfile}"
            };

            await _emailService.SendEmailAsync(templateType, toUser, emailData, _emailService.EmailDirectory.SupportEmail);
        }

        private async Task SendWeeklyPaymentsFailedEmailToAdminAsync(List<FailedWeeklyPaymentDetailDto> failedPayments, DateTime date, bool secondAttempt)
        {
            if (!failedPayments.Any())
            {
                return;
            }

            var details = failedPayments
                .Select(e => new FailedWeeklyPaymentDetailEmailDataDto
                {
                    ClientId = e.ClientId.ToString(),
                    Email = e.Email,
                    CustomerName = $"{e.FirstName} {e.LastName}",
                    PaymentAmount = e.PaymentAmount.ToString("C"),
                })
                .ToList();

            var emailData = new FailedWeeklyPaymentsListEmailDataDto
            {
                Details = details,
                IsWednesday = !secondAttempt,
                EventDate = $"{date:dddd, MMMM dd}"
            };

            var toUser = _emailService.EmailDirectory.SupportEmail;

            await _emailService.SendEmailAsync(EmailTemplateType.FailedPaymentsToAdmin, toUser, emailData);
        }
        #endregion
    }
}

```